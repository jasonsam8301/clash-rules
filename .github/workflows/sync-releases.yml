# üîÑ Clash Rules Releases Ëá™ÂãïÂêåÊ≠•Â∑•‰ΩúÊµÅ
# 
# Â∞áÊ≠§Êñá‰ª∂ÊîæÂà∞‰Ω† fork ÁöÑ clash-rules ÂÄâÂ∫´ÁöÑ .github/workflows/ ÁõÆÈåÑ‰∏≠
# ÂÆÉÊúÉËá™ÂãïÂæû‰∏äÊ∏∏ Loyalsoldier/clash-rules ‰∏ãËºâÊúÄÊñ∞ Releases ‰∏¶ÁôºÂ∏ÉÂà∞‰Ω†ÁöÑ fork
#
# Ë®≠ÁΩÆÊ≠•È©üÔºö
# 1. Fork https://github.com/Loyalsoldier/clash-rules
# 2. Âú® fork ÂÄâÂ∫´‰∏≠ÂâµÂª∫ .github/workflows/sync-releases.yml
# 3. Â∞áÊ≠§Êñá‰ª∂ÂÖßÂÆπË§áË£ΩÈÄ≤Âéª
# 4. Á¢∫‰øùÂÄâÂ∫´ÁöÑ Actions Ê¨äÈôêÂ∑≤ÈñãÂïü

name: Sync Releases from Upstream

on:
  schedule:
    # ÊØèÂ§© UTC 01:00 Âü∑Ë°å
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      force:
        description: 'Âº∑Âà∂ÈáçÊñ∞ÁôºÂ∏É'
        required: false
        default: 'false'

env:
  UPSTREAM_REPO: Loyalsoldier/clash-rules
  
jobs:
  sync-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get upstream latest release
        id: upstream
        run: |
          RELEASE_INFO=$(curl -s "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest")
          TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "üì¶ Upstream latest: $TAG"
      
      - name: Check if release exists
        id: check
        run: |
          TAG="${{ steps.upstream.outputs.tag }}"
          EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG")
          
          if [ "$EXISTS" = "200" ] && [ "${{ github.event.inputs.force }}" != "true" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Download upstream release assets
        if: steps.check.outputs.exists == 'false'
        run: |
          mkdir -p release-assets
          TAG="${{ steps.upstream.outputs.tag }}"
          
          ASSETS=$(curl -s "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest" \
            | jq -r '.assets[].browser_download_url')
          
          for url in $ASSETS; do
            filename=$(basename "$url")
            echo "üì• Downloading: $filename"
            curl -fSL "$url" -o "release-assets/$filename"
          done
          
          ls -lh release-assets/
      
      - name: Sync upstream code
        if: steps.check.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git" || true
          git fetch upstream --tags
          
          git checkout master || git checkout main
          git reset --hard upstream/master || git reset --hard upstream/main
          git push origin HEAD --force
          
          # ÂêåÊ≠• release ÂàÜÊîØ
          if git ls-remote --heads upstream release | grep -q release; then
            git checkout -B release upstream/release
            git push origin release --force
          fi
          
          git push origin --tags --force
      
      - name: Create release
        if: steps.check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.upstream.outputs.tag }}
          name: ${{ steps.upstream.outputs.tag }}
          body: |
            üîÑ **Synced from upstream**
            
            - Source: [${{ env.UPSTREAM_REPO }}](https://github.com/${{ env.UPSTREAM_REPO }})
            - Original: https://github.com/${{ env.UPSTREAM_REPO }}/releases/tag/${{ steps.upstream.outputs.tag }}
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

